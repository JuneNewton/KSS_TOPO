"use-struct";const fs=require("fs"),path=require("path"),_=require("lodash"),DateFormat=require("./ksl_date_format"),dateFormat=new DateFormat,{workerData:workerData,parentPort:parentPort,threadId:threadId}=require("worker_threads"),{stringify:stringify}=require("querystring"),logger=require("ksl-log-helper").logger,KIOSERVER_STATUS_TOPIC="data_source_node_status";let sourceNameAndTagsMap=workerData.sourceNameAndTagsMap,clientName=workerData.clientName,kio_info_key=workerData.kio_info_key_tmp;const logLevel=workerData.logLevel;logger.setLevel(logLevel),logger.info("Parse MQ threadId->"+threadId);const ERROR_CONFIG_FILE="../Config/ksl_errormsg.json",TOPIC_PREFIX={DATA_CHANGE:"datachange_",QUERY_RESULT:"query_result_",SET_DATA_RESULT:"setdata_result_",CLINET_NAME:"_"+clientName};function parseVarObj(e,r){let t=[],a=findSourceFromTopic(e);if(void 0===r.Objs)return logger.error("The originalObj.Objs is Undefined"),t;let o=sourceNameAndTagsMap.get(a);if(null===a||void 0===o)return logger.error("Can Not Find The Source Name!SourceName->"+a),t;let i=r.PVs[kio_info_key.DEFAULT_VALUE],n=r.PVs[kio_info_key.DEFAULT_TIME],s=r.PVs[kio_info_key.DEFAULT_QUALITY];for(let e=0,a=r.Objs.length;e<a;++e){let a=r.Objs[e],_=a.N,T=o.get(_);if(Array.isArray(T))for(let e=0;e<T.length;++e){let r={};r.N=T[e],void 0!==a[kio_info_key.DEFAULT_VALUE]?r.V=a[kio_info_key.DEFAULT_VALUE]:r.V=i;let o=a[kio_info_key.DEFAULT_TIME];if(void 0!==o){r.T=n+o;let e=(new Date).getTimezoneOffset()/60*-1,t="yyyy-MM-dd HH:mm:ss.SSS",a=new Date(Date.parse(n)-60*((new Date).getTimezoneOffset()+60*e)*1e3).getTime()+o,i=dateFormat.format(t,new Date(parseInt(a,10)+60*((new Date).getTimezoneOffset()+60*e)*1e3));r.T=i}else r.T=n;void 0!==a[kio_info_key.DEFAULT_QUALITY]?r.Q=a[kio_info_key.DEFAULT_QUALITY]:r.Q=s,t.push(r)}}return t}function findSourceFromTopic(e){return e.includes(TOPIC_PREFIX.DATA_CHANGE)?e=e.replace(TOPIC_PREFIX.DATA_CHANGE,""):e.includes(TOPIC_PREFIX.QUERY_RESULT)?e=(e=e.replace(TOPIC_PREFIX.QUERY_RESULT,"")).replace(TOPIC_PREFIX.CLINET_NAME,""):e.includes(TOPIC_PREFIX.SET_DATA_RESULT)?e=(e=e.replace(TOPIC_PREFIX.SET_DATA_RESULT,"")).replace(TOPIC_PREFIX.CLINET_NAME,""):(logger.error("Unhandled Topic->"+e),e=null),e}parentPort.on("message",e=>{try{let r=_.get(e,"topic",""),t=e.msg,a=[];if(r.includes(TOPIC_PREFIX.DATA_CHANGE))a=parseVarObj(r,t);else if(e.sourceNameAndTagsMap&&e.clientName)sourceNameAndTagsMap=e.sourceNameAndTagsMap,clientName=e.clientName;else{if("1"!==JSON.stringify(t.Type)||void 0===t.PVs)return;a=parseVarObj(r,t);let e=new Date+"The KIOServer is Online! Topic->"+r;logger.info(e)}let o={};o.topic=r,o.msg=a,parentPort.postMessage(o)}catch(e){logger.error("Parse MQ Data Thread Error -> "+e.message)}});